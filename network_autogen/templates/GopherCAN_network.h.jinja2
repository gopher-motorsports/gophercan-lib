// AUTO_GENERATED BY network_autogen/autogen.py

#ifndef GOPHERCAN_NETWORK_H
#define GOPHERCAN_NETWORK_H

#include <stdint.h>
#include "stm32f4xx_hal.h"
#include "cmsis_os.h"
#include "GopherCAN_config.h"

#define CAN_DATA_BYTES 8
#define MUTEX_TIMEOUT 5

// *** TYPES ***

typedef enum {
    COMMAND = 0,
    UNSIGNED8 = 1,
    UNSIGNED16 = 2,
    UNSIGNED32 = 3,
    UNSIGNED64 = 4,
    SIGNED8 = 5,
    SIGNED16 = 6,
    SIGNED32 = 7,
    SIGNED64 = 8,
    FLOATING = 9
} DATATYPES;

typedef enum {
    REQ_PARAM_SIZE = 0,
    COMMAND_SIZE = 5,
    UNSIGNED8_SIZE = 1,
    UNSIGNED16_SIZE = 2,
    UNSIGNED32_SIZE = 4,
    UNSIGNED64_SIZE = 8,
    SIGNED8_SIZE = 1,
    SIGNED16_SIZE = 2,
    SIGNED32_SIZE = 4,
    SIGNED64_SIZE = 8,
    FLOATING_SIZE = 4
} DATATYPES_SIZE;

// *** MESSAGE BUFFERS ***

typedef struct {
    CAN_TxHeaderTypeDef header;
    uint8_t data[CAN_DATA_BYTES];
    uint32_t rx_time;
} CAN_MSG;

typedef struct {
    CAN_MSG* messages;
    uint8_t size;
    uint8_t fill;
    uint8_t head;
    osMutexId mutex;
} CAN_BUFFER;

#define IS_FULL(buffer) ((buffer)->fill >= (buffer)->size)
#define IS_EMPTY(buffer) ((buffer)->fill == 0)
#define GET_FROM_BUFFER(buffer, index) ((buffer)->messages + (((buffer)->head + index) % (buffer)->size))

extern CAN_BUFFER RX_BUFF;

// *** BUSES ***

typedef enum {
    {% for bus_id in buses -%}
    {{ bus_id }} = {{ loop.index - 1 }},
    {% endfor %}
    ALL_BUSSES
} BUS_ID;

typedef struct {
    BUS_ID id;
    CAN_HandleTypeDef* hcan;
    CAN_BUFFER* tx_buffer;
} CAN_BUS;

extern CAN_BUS* BUSES[ALL_BUSSES];

// *** MODULES ***

typedef enum {
    ALL_MODULES_ID = 0,
    {% for key, value in modules.items() -%}
    {{ key }}_ID = {{ value.id }},
    {% endfor %}
    NUM_OF_MODULES
} MODULE_ID;

extern BUS_ID module_bus_number[NUM_OF_MODULES];

// *** PARAMETERS ***

typedef enum {
    EMPTY_ID = 0,
    {% for id, value in parameters.items() -%}
    {{ value.name.upper() }}_ID = {{ id }},
    {% endfor %}
    NUM_OF_PARAMETERS
} GCAN_PARAM_ID;

typedef enum {
    LSB,
    MSB
} ENCODING;

typedef struct {
    GCAN_PARAM_ID ID;
    uint16_t GROUP_ID;
    DATATYPES TYPE;
    DATATYPES_SIZE SIZE;
    ENCODING ENC;
    uint8_t ENC_SIZE;
    float SCALE;
    float OFFSET;
    uint32_t last_tx;
    uint32_t last_rx;
    uint8_t pending_response;
} CAN_INFO_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    uint8_t data;
} U8_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    uint16_t data;
} U16_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    uint32_t data;
} U32_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    uint64_t data;
} U64_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    int8_t data;
} S8_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    int16_t data;
} S16_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    int32_t data;
} S32_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    int64_t data;
} S64_CAN_STRUCT;

typedef struct {
    CAN_INFO_STRUCT info;
    float data;
} FLOAT_CAN_STRUCT;

{% for id, value in parameters.items() -%}
extern {{ param_structs[value.type] }} {{ value.name }};
{% endfor %}
extern void* PARAMETERS[NUM_OF_PARAMETERS];

// *** GROUPS ***

#define NUM_OF_GROUPS {{ groups|length }}

typedef struct
{
    uint16_t group_id;
    GCAN_PARAM_ID param_ids[CAN_DATA_BYTES];
} PARAM_GROUP;

extern PARAM_GROUP GROUPS[NUM_OF_GROUPS];

// *** COMMANDS ***

typedef enum
{
    {% for name, value in commands.items() -%}
    {{ name.upper() }} = {{ value.id }},
    {% endfor %}
    NUM_OF_COMMANDS
} GCAN_COMMAND_ID;

// *** ERRORS ***

{% for name, value in errors.items() -%}
#define {{ name.upper() }} {{ value.id }}
{% endfor %}
typedef struct
{
    uint32_t last_rx;
    uint8_t  source_module;
    uint16_t parameter;
    uint8_t  error_id;
} ERROR_MSG;

void GCAN_InitNetwork();

#endif /* GOPHERCAN_NETWORK_H */